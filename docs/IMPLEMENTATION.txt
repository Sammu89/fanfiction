 üõ†Ô∏è IMPLEMENTATION PLAN: Fanfiction Manager Fixes

  Comprehensive Implementation Guide for Coding Agents

  ---
  üìã OVERVIEW

  This document provides exact instructions for implementing fixes to the Fanfiction Manager plugin. Each task is self-contained with specific file paths, line numbers, code changes, and testing instructions.

  ---
  üéØ TASK 1: Fix Slug Synchronization Bug

  Priority: CRITICAL
  Estimated Time: 30 minutes
  Files to Modify: 3 files

  Problem Statement

  - Dashboard slug stored in 3 different options causes sync issues
  - When user changes "dashboard" ‚Üí "dashboard1", only some options update
  - URL Manager loads from fanfic_dynamic_page_slugs which may not be synced

  Solution: Eliminate Duplicate Storage

  Step 1.1: Remove Secondary Paths Option Usage

  File: includes/class-fanfic-url-manager.php

  Change Line 130: Remove secondary paths from slug loading
  // BEFORE (line 130):
  'secondary'  => wp_parse_args( get_option( 'fanfic_secondary_paths', array() ), $secondary_defaults ),

  // AFTER:
  // REMOVED - no longer needed, dashboard/search are in dynamic_page_slugs only

  Change Line 238-249: Remove register_secondary_path_rules() method entirely
  // BEFORE (lines 238-249):
  private function register_secondary_path_rules() {
      $secondary = $this->slugs['secondary'];

      // User profile: /user/{username}/
      if ( isset( $secondary['user'] ) ) {
          add_rewrite_rule(
              '^' . $secondary['user'] . '/([^/]+)/?$',
              'index.php?fanfic_page=user&fanfic_user=$matches[1]',
              'top'
          );
      }
  }

  // AFTER:
  // DELETE ENTIRE METHOD

  Change Line 145: Remove call to deleted method
  // BEFORE (line 145):
  $this->register_story_rules();
  $this->register_dynamic_page_rules();
  $this->register_secondary_path_rules();  // ‚Üê REMOVE THIS LINE

  // AFTER:
  $this->register_story_rules();
  $this->register_dynamic_page_rules();

  Change Line 659-661: Remove get_secondary_slugs() method
  // BEFORE (lines 659-661):
  public function get_secondary_slugs() {
      return $this->slugs['secondary'];
  }

  // AFTER:
  // DELETE ENTIRE METHOD

  ---
  Step 1.2: Update URL Config to Use Single Source

  File: includes/class-fanfic-url-config.php

  Change Lines 1211-1253: Remove secondary path saving logic, update dynamic slugs directly

  // BEFORE (lines 1211-1253):
  // 4. Save secondary paths (dashboard, user, search) - grouped
  $secondary_slugs_input = array();
  $secondary_config = Fanfic_URL_Schema::get_slugs_by_group( 'secondary' );

  foreach ( $secondary_config as $key => $config ) {
      $field_name = 'fanfic_' . $key . '_slug';
      if ( isset( $_POST[ $field_name ] ) ) {
          $secondary_slugs_input[ $key ] = sanitize_title( wp_unslash( $_POST[ $field_name ] ) );
      }
  }

  // Check for duplicates
  if ( Fanfic_URL_Schema::has_duplicates( $secondary_slugs_input ) ) {
      $errors[] = __( 'User & System URLs must be unique from each other.', 'fanfiction-manager' );
  } else {
      // Validate and save each
      $all_valid = true;
      foreach ( $secondary_slugs_input as $key => $slug ) {
          $validation = $this->validate_slug( $slug, array( $key ) );
          if ( is_wp_error( $validation ) ) {
              $errors[] = ucfirst( $key ) . ': ' . $validation->get_error_message();
              $all_valid = false;
          }
      }

      if ( $all_valid ) {
          update_option( self::OPTION_SECONDARY_PATHS, $secondary_slugs_input );

          // Update dynamic pages if applicable
          if ( class_exists( 'Fanfic_URL_Manager' ) ) {
              $dynamic_updates = array();
              foreach ( $secondary_config as $key => $config ) {
                  if ( isset( $config['is_dynamic_page'] ) && $config['is_dynamic_page'] && ! empty( $secondary_slugs_input[ $key ] ) ) {
                      $dynamic_updates[ $key ] = $secondary_slugs_input[ $key ];
                  }
              }
              if ( ! empty( $dynamic_updates ) ) {
                  $current_dynamic = Fanfic_URL_Manager::get_instance()->get_slugs();
                  Fanfic_URL_Manager::get_instance()->update_slugs( array_merge( $current_dynamic, $dynamic_updates ) );
              }
          }

          $success_messages[] = __( 'User & system URLs saved.', 'fanfiction-manager' );
      }
  }

  // AFTER (simplified - save directly to dynamic slugs):
  // 4. Save dynamic page slugs (dashboard, search, members)
  $dynamic_slugs_input = array();

  // Dashboard
  if ( isset( $_POST['fanfic_dashboard_slug'] ) ) {
      $dynamic_slugs_input['dashboard'] = sanitize_title( wp_unslash( $_POST['fanfic_dashboard_slug'] ) );
  }

  // Search
  if ( isset( $_POST['fanfic_search_slug'] ) ) {
      $dynamic_slugs_input['search'] = sanitize_title( wp_unslash( $_POST['fanfic_search_slug'] ) );
  }

  // Members (formerly 'user' slug, now 'members')
  if ( isset( $_POST['fanfic_members_slug'] ) ) {
      $dynamic_slugs_input['members'] = sanitize_title( wp_unslash( $_POST['fanfic_members_slug'] ) );
  }

  // Validate uniqueness
  if ( Fanfic_URL_Schema::has_duplicates( $dynamic_slugs_input ) ) {
      $errors[] = __( 'Dynamic page URLs must be unique from each other.', 'fanfiction-manager' );
  } else {
      // Validate each slug
      $all_valid = true;
      foreach ( $dynamic_slugs_input as $key => $slug ) {
          $validation = $this->validate_slug( $slug, array( $key ) );
          if ( is_wp_error( $validation ) ) {
              $errors[] = ucfirst( $key ) . ': ' . $validation->get_error_message();
              $all_valid = false;
          }
      }

      if ( $all_valid ) {
          // Get current dynamic slugs and merge
          $current_dynamic = get_option( 'fanfic_dynamic_page_slugs', array() );
          $updated_dynamic = array_merge( $current_dynamic, $dynamic_slugs_input );

          update_option( 'fanfic_dynamic_page_slugs', $updated_dynamic );

          // Immediately flush URL Manager cache
          if ( class_exists( 'Fanfic_URL_Manager' ) ) {
              Fanfic_URL_Manager::get_instance()->flush_cache();
          }

          $success_messages[] = __( 'Dynamic page URLs saved.', 'fanfiction-manager' );
      }
  }

  Change Lines 1363-1387: Fix flush method to eliminate transient delay

  // BEFORE (lines 1363-1387):
  private function flush_all_rewrite_rules() {
      // Flush URL Manager cache (reloads all slugs)
      if ( class_exists( 'Fanfic_URL_Manager' ) ) {
          Fanfic_URL_Manager::get_instance()->flush_cache();
      }

      // Also call Dynamic Pages to register its rules
      if ( class_exists( 'Fanfic_Dynamic_Pages' ) ) {
          Fanfic_Dynamic_Pages::add_rewrite_rules();
      }

      // Register all rewrite rules before flushing
      if ( class_exists( 'Fanfic_Post_Types' ) ) {
          Fanfic_Post_Types::register();
      }
      if ( class_exists( 'Fanfic_Taxonomies' ) ) {
          Fanfic_Taxonomies::register();
      }
      if ( class_exists( 'Fanfic_URL_Manager' ) ) {
          Fanfic_URL_Manager::get_instance()->register_rewrite_rules();
      }

      flush_rewrite_rules();
      set_transient( 'fanfic_flush_rewrite_rules', 1, 60 );  // ‚Üê REMOVE THIS
  }

  // AFTER:
  private function flush_all_rewrite_rules() {
      // Flush URL Manager cache (reloads all slugs)
      if ( class_exists( 'Fanfic_URL_Manager' ) ) {
          Fanfic_URL_Manager::get_instance()->flush_cache();
      }

      // Register all rewrite rules before flushing
      if ( class_exists( 'Fanfic_Post_Types' ) ) {
          Fanfic_Post_Types::register();
      }
      if ( class_exists( 'Fanfic_Taxonomies' ) ) {
          Fanfic_Taxonomies::register();
      }
      if ( class_exists( 'Fanfic_URL_Manager' ) ) {
          Fanfic_URL_Manager::get_instance()->register_rewrite_rules();
      }

      // Flush immediately - no transient delay
      flush_rewrite_rules();
  }

  ---
  Step 1.3: Update Form Fields in URL Config

  File: includes/class-fanfic-url-config.php

  Change Lines 376-425: Update form field rendering to remove "user" slug, keep only dynamic pages

  // FIND (around line 405):
  // Member Directory
  self::render_slug_input_row( array(
      'id'             => 'fanfic_user_slug',
      'name'           => 'fanfic_user_slug',
      'label'          => __( 'Member Directory', 'fanfiction-manager' ),
      'value'          => isset( $current_slugs['user'] ) ? $current_slugs['user'] : 'user',
      'preview_id'     => 'user-preview-code',
      'preview_html'   => $base_url . '<span class="fanfic-dynamic-slug">user</span>/username/',
      'required'       => true,
      'data_slug_type' => 'user',
  ) );

  // REPLACE WITH:
  // Members (Directory + Profiles)
  self::render_slug_input_row( array(
      'id'             => 'fanfic_members_slug',
      'name'           => 'fanfic_members_slug',
      'label'          => __( 'Members (Directory + Profiles)', 'fanfiction-manager' ),
      'value'          => isset( $current_slugs['members'] ) ? $current_slugs['members'] : 'members',
      'preview_id'     => 'members-preview-code',
      'preview_html'   => $base_url . '<span class="fanfic-dynamic-slug">members</span>/ and /members/username/',
      'required'       => true,
      'data_slug_type' => 'members',
      'description'    => __( 'Handles both author directory list and individual profiles', 'fanfiction-manager' ),
  ) );

  ---
  Step 1.4: Remove Transient Check in URL Manager

  File: includes/class-fanfic-url-manager.php

  Change Lines 785-789: Remove transient-based delayed flush

  // BEFORE (lines 785-789):
  public function maybe_flush_rewrite_rules() {
      if ( get_transient( 'fanfic_flush_rewrite_rules' ) ) {
          flush_rewrite_rules();
          delete_transient( 'fanfic_flush_rewrite_rules' );
      }
  }

  // AFTER:
  // DELETE ENTIRE METHOD - no longer needed

  Change Line 98: Remove hook registration for deleted method
  // BEFORE (line 98):
  add_action( 'init', array( $this, 'maybe_flush_rewrite_rules' ), 25 );

  // AFTER:
  // REMOVE THIS LINE

  ---
  Testing Instructions for Task 1

  1. Go to: WordPress Admin ‚Üí Fanfiction Manager ‚Üí URL Settings
  2. Change: Dashboard slug from "dashboard" to "dashboard-test"
  3. Save the settings
  4. Add debug code temporarily:
  add_action('wp_footer', function() {
      if (!current_user_can('manage_options')) return;
      $slugs = Fanfic_URL_Manager::get_instance()->get_all_slugs();
      echo '<pre>Dynamic Slugs: ' . print_r($slugs['dynamic'], true) . '</pre>';
  });
  5. Visit any frontend page
  6. Verify: Output shows 'dashboard' => 'dashboard-test'
  7. Visit: /base_slug/dashboard-test/
  8. Expected: Dashboard page loads successfully (no 404)
  9. Verify Database:
  SELECT option_value FROM wp_options WHERE option_name = 'fanfic_dynamic_page_slugs';
  -- Should show: {"dashboard":"dashboard-test",...}

  SELECT option_value FROM wp_options WHERE option_name = 'fanfic_secondary_paths';
  -- Should NOT exist or be empty

  ---
  üéØ TASK 2: Add Headers/Footers to Templates

  Priority: HIGH
  Estimated Time: 15 minutes
  Files to Modify: 2 files

  Problem Statement

  - template-search.php and template-members.php are missing get_header() and get_footer() calls
  - This causes them to appear without theme styling

  ---
  Step 2.1: Fix template-search.php

  File: templates/template-search.php

  REPLACE ENTIRE FILE with:
  <?php
  /**
   * Template: Search Page
   *
   * Displays story search form and results
   *
   * @package Fanfiction_Manager
   * @since 1.0.0
   */

  // Security check - prevent direct access
  if ( ! defined( 'ABSPATH' ) ) {
      exit;
  }

  get_header();
  ?>

  <div class="fanfic-template-wrapper">
  <a href="#fanfic-main-content" class="skip-link"><?php esc_html_e( 'Skip to main content', 'fanfiction-manager' ); ?></a>

  <main id="fanfic-main-content" class="fanfic-main-content" role="main">
      <article class="fanfic-page-content">
          <header class="fanfic-page-header">
              <h1 class="fanfic-page-title"><?php esc_html_e( 'Search Stories', 'fanfiction-manager' ); ?></h1>
          </header>

          <section class="fanfic-content-section" role="search" aria-label="<?php esc_attr_e( 'Search form', 'fanfiction-manager' ); ?>">
              <?php echo do_shortcode( '[search-form]' ); ?>
          </section>

          <section class="fanfic-content-section" role="region" aria-label="<?php esc_attr_e( 'Search results', 'fanfiction-manager' ); ?>">
              <?php echo do_shortcode( '[search-results]' ); ?>
          </section>
      </article>
  </main>
  </div>

  <?php get_footer(); ?>

  Key Changes:
  - ‚úÖ Added get_header() at line 15
  - ‚úÖ Added get_footer() at line 41
  - ‚úÖ Wrapped shortcodes in do_shortcode() at lines 27 and 31
  - ‚úÖ Removed <p> tags around shortcodes

  ---
  Step 2.2: Fix template-members.php

  File: templates/template-members.php

  REPLACE ENTIRE FILE with:
  <?php
  /**
   * Template: Members Directory & User Profiles
   *
   * Displays:
   * - /members/ ‚Üí List of all authors (using WordPress native WP_User_Query)
   * - /members/username/ ‚Üí Individual user profile
   *
   * @package Fanfiction_Manager
   * @since 1.0.0
   */

  if ( ! defined( 'ABSPATH' ) ) {
      exit;
  }

  get_header();

  // Get member_name query var to determine if showing list or profile
  $member_name = get_query_var( 'member_name' );
  $is_profile_view = ! empty( $member_name );
  ?>

  <div class="fanfic-template-wrapper">
  <a href="#fanfic-main-content" class="skip-link"><?php esc_html_e( 'Skip to main content', 'fanfiction-manager' ); ?></a>

  <main id="fanfic-main-content" class="fanfic-main-content" role="main">

  <?php if ( $is_profile_view ) : ?>
      <!-- INDIVIDUAL USER PROFILE -->
      <article class="fanfic-page-members fanfic-user-profile">
          <?php
          // Get user by username
          $user = get_user_by( 'login', $member_name );

          if ( ! $user ) {
              ?>
              <div class="fanfic-error-notice" role="alert">
                  <p><?php esc_html_e( 'User not found.', 'fanfiction-manager' ); ?></p>
              </div>
              <?php
          } else {
              // Check if editing
              $is_editing = isset( $_GET['action'] ) && $_GET['action'] === 'edit';

              if ( $is_editing ) {
                  // Check permissions
                  if ( ! is_user_logged_in() || ( get_current_user_id() !== $user->ID && ! current_user_can( 'edit_users' ) ) ) {
                      ?>
                      <div class="fanfic-error-notice" role="alert">
                          <p><?php esc_html_e( 'You do not have permission to edit this profile.', 'fanfiction-manager' ); ?></p>
                      </div>
                      <?php
                  } else {
                      // Load edit profile template
                      echo do_shortcode( '[edit-profile-form]' );
                  }
              } else {
                  // Display profile using template from settings
                  $template = get_option( 'fanfic_profile_view_template', '' );

                  // If no custom template, use default
                  if ( empty( $template ) && class_exists( 'Fanfic_Settings' ) ) {
                      $reflection = new ReflectionClass( 'Fanfic_Settings' );
                      if ( $reflection->hasMethod( 'get_default_profile_template' ) ) {
                          $method = $reflection->getMethod( 'get_default_profile_template' );
                          $method->setAccessible( true );
                          $template = $method->invoke( null );
                      }
                  }

                  // Process shortcodes in template
                  echo do_shortcode( $template );
              }
          }
          ?>
      </article>

  <?php else : ?>
      <!-- AUTHOR DIRECTORY LIST -->
      <article class="fanfic-page-members fanfic-members-directory">
          <header class="fanfic-page-header">
              <h1 class="fanfic-page-title"><?php esc_html_e( 'Authors Directory', 'fanfiction-manager' ); ?></h1>
              <p class="fanfic-page-description"><?php esc_html_e( 'Browse all authors and their works', 'fanfiction-manager' ); ?></p>
          </header>

          <div class="fanfic-members-list">
              <?php
              // Use WordPress native WP_User_Query
              $paged = ( get_query_var( 'paged' ) ) ? absint( get_query_var( 'paged' ) ) : 1;

              $args = array(
                  'role__in' => array( 'fanfiction_author', 'fanfiction_moderator', 'administrator' ),
                  'orderby'  => 'display_name',
                  'order'    => 'ASC',
                  'number'   => 20, // Authors per page
                  'paged'    => $paged,
              );

              $user_query = new WP_User_Query( $args );
              $authors = $user_query->get_results();

              if ( ! empty( $authors ) ) {
                  ?>
                  <div class="fanfic-members-grid">
                      <?php foreach ( $authors as $author ) :
                          // Get author stats
                          $story_count = count_user_posts( $author->ID, 'fanfiction_story', true );
                          $profile_url = Fanfic_URL_Manager::get_instance()->get_page_url( 'members', array( 'member_name' => $author->user_login ) );
                      ?>
                          <div class="fanfic-member-card">
                              <div class="fanfic-member-avatar">
                                  <?php echo get_avatar( $author->ID, 80 ); ?>
                              </div>
                              <div class="fanfic-member-info">
                                  <h2 class="fanfic-member-name">
                                      <a href="<?php echo esc_url( $profile_url ); ?>">
                                          <?php echo esc_html( $author->display_name ); ?>
                                      </a>
                                  </h2>
                                  <p class="fanfic-member-stats">
                                      <?php
                                      printf(
                                          esc_html( _n( '%d story', '%d stories', $story_count, 'fanfiction-manager' ) ),
                                          $story_count
                                      );
                                      ?>
                                  </p>
                              </div>
                          </div>
                      <?php endforeach; ?>
                  </div>

                  <?php
                  // Pagination
                  $total_users = $user_query->get_total();
                  $total_pages = ceil( $total_users / 20 );

                  if ( $total_pages > 1 ) {
                      echo '<nav class="fanfic-pagination" role="navigation" aria-label="' . esc_attr__( 'Authors pagination', 'fanfiction-manager' ) . '">';
                      echo paginate_links( array(
                          'base'      => get_pagenum_link( 1 ) . '%_%',
                          'format'    => 'page/%#%/',
                          'current'   => $paged,
                          'total'     => $total_pages,
                          'prev_text' => __( '&laquo; Previous', 'fanfiction-manager' ),
                          'next_text' => __( 'Next &raquo;', 'fanfiction-manager' ),
                      ) );
                      echo '</nav>';
                  }
              } else {
                  ?>
                  <div class="fanfic-no-results">
                      <p><?php esc_html_e( 'No authors found.', 'fanfiction-manager' ); ?></p>
                  </div>
                  <?php
              }
              ?>
          </div>
      </article>
  <?php endif; ?>

  </main>
  </div>

  <?php get_footer(); ?>

  Key Changes:
  - ‚úÖ Added get_header() at line 17
  - ‚úÖ Added get_footer() at line 173
  - ‚úÖ Implemented WordPress native WP_User_Query for author listing (lines 97-172)
  - ‚úÖ Added pagination support (lines 143-158)
  - ‚úÖ Separated profile view from directory list with conditional logic (lines 29-90)
  - ‚úÖ Uses do_shortcode() for profile template (line 77)

  ---
  Testing Instructions for Task 2

  Test template-search.php:
  1. Visit: /base_slug/search/
  2. Expected: Full page with theme header/footer
  3. Check: Search form displays and functions
  4. Verify: No <p>[search-form]</p> visible in source

  Test template-members.php:
  1. Visit: /base_slug/members/
  2. Expected: List of authors with avatars and story counts
  3. Check: Pagination appears if more than 20 authors
  4. Click on an author
  5. Visit: /base_slug/members/username/
  6. Expected: User profile displays
  7. Check: Theme header and footer present

  ---
  üéØ TASK 3: Remove /user/ Path and Deprecated References

  Priority: MEDIUM
  Estimated Time: 20 minutes
  Files to Modify: 4 files

  Problem Statement

  - Old /user/username/ secondary path exists but isn't used
  - Should use only /members/username/ for profiles
  - Remove all deprecated edit page references as separate pages

  ---
  Step 3.1: Remove User Secondary Path from URL Schema

  File: includes/class-fanfic-url-schema.php

  Find and remove the 'user' entry from secondary paths configuration (approximate line 150-200):

  // FIND and REMOVE:
  'user' => array(
      'label' => __( 'User Profile', 'fanfiction-manager' ),
      'default' => 'user',
      'group' => 'secondary',
      'template' => '{home}{base}/{user}/username/',
      // ... etc
  ),

  ---
  Step 3.2: Remove Deprecated Edit Page References

  File: includes/functions.php

  Find lines around 396, 407, 424 and replace with new implementations:

  // FIND (around line 396):
  function fanfic_get_edit_story_url( $story_id ) {
      $page_id = Fanfic_Templates::get_page_id_by_slug( 'edit-story' );
      if ( ! $page_id ) {
          return '';
      }
      return add_query_arg( 'story_id', $story_id, get_permalink( $page_id ) );
  }

  // REPLACE WITH:
  function fanfic_get_edit_story_url( $story_id ) {
      return Fanfic_URL_Manager::get_instance()->get_edit_url( 'story', $story_id );
  }

  // FIND (around line 407):
  function fanfic_get_edit_chapter_url( $chapter_id ) {
      $page_id = Fanfic_Templates::get_page_id_by_slug( 'edit-chapter' );
      if ( ! $page_id ) {
          return '';
      }
      return add_query_arg( 'chapter_id', $chapter_id, get_permalink( $page_id ) );
  }

  // REPLACE WITH:
  function fanfic_get_edit_chapter_url( $chapter_id ) {
      return Fanfic_URL_Manager::get_instance()->get_edit_url( 'chapter', $chapter_id );
  }

  // FIND (around line 424):
  function fanfic_get_edit_profile_url( $user_id = null ) {
      if ( null === $user_id ) {
          $user_id = get_current_user_id();
      }
      $page_id = Fanfic_Templates::get_page_id_by_slug( 'edit-profile' );
      if ( ! $page_id ) {
          return '';
      }
      return add_query_arg( 'user_id', $user_id, get_permalink( $page_id ) );
  }

  // REPLACE WITH:
  function fanfic_get_edit_profile_url( $user_id = null ) {
      if ( null === $user_id ) {
          $user_id = get_current_user_id();
      }
      return Fanfic_URL_Manager::get_instance()->get_edit_url( 'profile', $user_id );
  }

  ---
  Step 3.3: Update Wizard to Not Create Edit Pages

  File: includes/class-fanfic-wizard.php

  Find the method all_pages_exist() (around line 318) and remove checks for edit pages:

  // FIND (in all_pages_exist method, around lines 320-350):
  $required_pages = array(
      'main',
      'login',
      'register',
      'password-reset',
      'error',
      'maintenance',
      'edit-story',       // ‚Üê REMOVE THIS
      'edit-chapter',     // ‚Üê REMOVE THIS
      'edit-profile',     // ‚Üê REMOVE THIS
      'create-chapter',   // ‚Üê REMOVE THIS (now uses ?action=create-chapter)
  );

  // REPLACE WITH:
  $required_pages = array(
      'main',
      'login',
      'register',
      'password-reset',
      'error',
      'maintenance',
  );

  ---
  Step 3.4: Update Templates Class to Skip Edit Pages

  File: includes/class-fanfic-templates.php

  Find the create_system_pages() method (around line 605) and update the pages array:

  // FIND the $pages array definition (around line 615-690):
  $pages = array(
      'main' => array( ... ),
      'login' => array( ... ),
      'register' => array( ... ),
      'password-reset' => array( ... ),
      'error' => array( ... ),
      'maintenance' => array( ... ),
      'edit-story' => array( ... ),      // ‚Üê REMOVE THIS ENTIRE ENTRY
      'edit-chapter' => array( ... ),    // ‚Üê REMOVE THIS ENTIRE ENTRY
      'edit-profile' => array( ... ),    // ‚Üê REMOVE THIS ENTIRE ENTRY
      'create-chapter' => array( ... ),  // ‚Üê REMOVE THIS ENTIRE ENTRY
  );

  ---
  Testing Instructions for Task 3

  1. Run Wizard Again:
    - Go to: Fanfiction Manager ‚Üí Setup Wizard
    - Complete all steps
    - Check: No "edit-story", "edit-chapter", "edit-profile", "create-chapter" pages created
    - Check: Only 6 WordPress pages exist (main, login, register, password-reset, error, maintenance)
  2. Test Edit URLs:
    - Create a test story
    - Click "Edit" on story
    - Expected URL: /base_slug/stories_slug/my-story/?action=edit
    - Expected: Edit form loads correctly
  3. Test Profile Edit:
    - Visit /base_slug/members/your-username/
    - Click "Edit Profile" (if link exists)
    - Expected URL: /base_slug/members/your-username/?action=edit
    - Expected: Edit profile form loads
  4. Verify Database:
  SELECT post_title FROM wp_posts WHERE post_type = 'page';
  -- Should NOT include: Edit Story, Edit Chapter, Edit Profile, Create Chapter

  ---
  üéØ TASK 4: Remove Duplicate Rewrite Rule Registration

  Priority: LOW
  Estimated Time: 15 minutes
  Files to Modify: 2 files

  Problem Statement

  - Both Fanfic_Dynamic_Pages and Fanfic_URL_Manager register the same rewrite rules
  - Fanfic_Dynamic_Pages class is now redundant

  ---
  Step 4.1: Remove Dynamic Pages Class Usage

  File: includes/class-fanfic-core.php

  Find line that loads the class (around line 60-90) and comment it out:

  // FIND:
  require_once FANFIC_INCLUDES_DIR . 'class-fanfic-dynamic-pages.php';

  // REPLACE WITH:
  // DEPRECATED: require_once FANFIC_INCLUDES_DIR . 'class-fanfic-dynamic-pages.php';
  // Now handled by Fanfic_URL_Manager

  ---
  Step 4.2: Remove Calls to Dynamic Pages in URL Config

  File: includes/class-fanfic-url-config.php

  Find the flush_all_rewrite_rules() method (around line 1363) and remove Dynamic Pages call:

  // FIND (in flush_all_rewrite_rules method):
  // Also call Dynamic Pages to register its rules
  if ( class_exists( 'Fanfic_Dynamic_Pages' ) ) {
      Fanfic_Dynamic_Pages::add_rewrite_rules();
  }

  // REPLACE WITH:
  // REMOVED: Fanfic_Dynamic_Pages class is deprecated, URL Manager handles all rules

  ---
  Step 4.3: Remove Dynamic Pages from Wizard

  File: includes/class-fanfic-wizard.php

  Find the flush_rewrite_rules() method (around line 1038) and remove Dynamic Pages call:

  // FIND (in flush_rewrite_rules method):
  // Call Dynamic Pages to register rules
  if ( class_exists( 'Fanfic_Dynamic_Pages' ) ) {
      Fanfic_Dynamic_Pages::add_rewrite_rules();
  }

  // REPLACE WITH:
  // REMOVED: Fanfic_Dynamic_Pages is deprecated

  ---
  Step 4.4: Add Comment to Dynamic Pages File

  File: includes/class-fanfic-dynamic-pages.php

  Add at top of file (after opening <?php and docblock):

  /**
   * @deprecated 1.1.0 This class is deprecated. All functionality moved to Fanfic_URL_Manager.
   * File kept for backward compatibility only. Will be removed in version 2.0.0.
   */

  ---
  Testing Instructions for Task 4

  1. Clear All Caches:
    - Deactivate and reactivate plugin
    - Go to: Settings ‚Üí Permalinks ‚Üí Save Changes
  2. Test All Dynamic Pages:
    - Visit: /base_slug/dashboard1/ ‚Üí Should work
    - Visit: /base_slug/search/ ‚Üí Should work
    - Visit: /base_slug/members/ ‚Üí Should work
    - Visit: /base_slug/criare/ ‚Üí Should work
  3. Check Error Logs:
  # Check for any errors related to Fanfic_Dynamic_Pages
  tail -f /path/to/wordpress/wp-content/debug.log
    - Expected: No errors mentioning Fanfic_Dynamic_Pages

  ---
  üéØ TASK 5: Fix Wizard Menu Creation

  Priority: MEDIUM
  Estimated Time: 30 minutes
  Files to Modify: 1 file

  Problem Statement

  - Wizard creates menu but doesn't respect custom slugs from user configuration
  - Menu items should use dynamic URLs from URL Manager

  ---
  Step 5.1: Update Menu Creation Method

  File: includes/class-fanfic-templates.php

  Find the create_fanfiction_menu() method (around line 847) and REPLACE ENTIRE METHOD with:

  /**
   * Create or recreate the Fanfiction Automatic Menu
   *
   * @since 1.0.0
   * @param array $page_ids Array of system page IDs.
   * @return int|WP_Error Menu ID on success, WP_Error on failure.
   */
  public static function create_fanfiction_menu( $page_ids ) {
      $menu_name = 'Fanfiction Automatic Menu';

      // Delete existing menu if it exists
      $existing_menu = wp_get_nav_menu_object( $menu_name );
      if ( $existing_menu ) {
          wp_delete_nav_menu( $existing_menu->term_id );
      }

      // Create new menu
      $menu_id = wp_create_nav_menu( $menu_name );

      if ( is_wp_error( $menu_id ) ) {
          return $menu_id;
      }

      // Get URL Manager instance for dynamic URLs
      $url_manager = Fanfic_URL_Manager::get_instance();

      // Menu item position counter
      $position = 0;

      // 1. HOME (always visible)
      wp_update_nav_menu_item( $menu_id, 0, array(
          'menu-item-title'   => __( 'Home', 'fanfiction-manager' ),
          'menu-item-url'     => home_url( '/' ),
          'menu-item-status'  => 'publish',
          'menu-item-position' => ++$position,
          'menu-item-classes' => 'fanfic-menu-home',
      ) );

      // 2. DASHBOARD (logged in only)
      $dashboard_url = $url_manager->get_page_url( 'dashboard' );
      if ( ! empty( $dashboard_url ) ) {
          wp_update_nav_menu_item( $menu_id, 0, array(
              'menu-item-title'   => __( 'Dashboard', 'fanfiction-manager' ),
              'menu-item-url'     => $dashboard_url,
              'menu-item-status'  => 'publish',
              'menu-item-position' => ++$position,
              'menu-item-classes' => 'fanfic-menu-dashboard menu-item-logged-in',
          ) );
      }

      // 3. ADD STORY (logged in only)
      $create_story_url = $url_manager->get_page_url( 'create-story' );
      if ( ! empty( $create_story_url ) ) {
          wp_update_nav_menu_item( $menu_id, 0, array(
              'menu-item-title'   => __( 'Add Story', 'fanfiction-manager' ),
              'menu-item-url'     => $create_story_url,
              'menu-item-status'  => 'publish',
              'menu-item-position' => ++$position,
              'menu-item-classes' => 'fanfic-menu-add-story menu-item-logged-in',
          ) );
      }

      // 4. STORIES ARCHIVE (always visible)
      $archive_url = get_post_type_archive_link( 'fanfiction_story' );
      if ( ! empty( $archive_url ) ) {
          wp_update_nav_menu_item( $menu_id, 0, array(
              'menu-item-title'   => __( 'Stories Archive', 'fanfiction-manager' ),
              'menu-item-url'     => $archive_url,
              'menu-item-status'  => 'publish',
              'menu-item-position' => ++$position,
              'menu-item-classes' => 'fanfic-menu-archive',
          ) );
      }

      // 5. MEMBERS (always visible)
      $members_url = $url_manager->get_page_url( 'members' );
      if ( ! empty( $members_url ) ) {
          wp_update_nav_menu_item( $menu_id, 0, array(
              'menu-item-title'   => __( 'Members', 'fanfiction-manager' ),
              'menu-item-url'     => $members_url,
              'menu-item-status'  => 'publish',
              'menu-item-position' => ++$position,
              'menu-item-classes' => 'fanfic-menu-members',
          ) );
      }

      // 6. LOGIN (logged out only)
      if ( isset( $page_ids['login'] ) && $page_ids['login'] > 0 ) {
          $login_url = get_permalink( $page_ids['login'] );
          if ( ! empty( $login_url ) ) {
              wp_update_nav_menu_item( $menu_id, 0, array(
                  'menu-item-title'   => __( 'Login', 'fanfiction-manager' ),
                  'menu-item-url'     => $login_url,
                  'menu-item-status'  => 'publish',
                  'menu-item-position' => ++$position,
                  'menu-item-classes' => 'fanfic-menu-login menu-item-logged-out',
              ) );
          }
      }

      // 7. LOGOUT (logged in only)
      wp_update_nav_menu_item( $menu_id, 0, array(
          'menu-item-title'   => __( 'Logout', 'fanfiction-manager' ),
          'menu-item-url'     => wp_logout_url( home_url( '/' ) ),
          'menu-item-status'  => 'publish',
          'menu-item-position' => ++$position,
          'menu-item-classes' => 'fanfic-menu-logout menu-item-logged-in',
      ) );

      return $menu_id;
  }

  Key Changes:
  - ‚úÖ Deletes and recreates menu on each run (lines 7-12)
  - ‚úÖ Uses Fanfic_URL_Manager::get_page_url() for dynamic URLs (lines 20-70)
  - ‚úÖ Adds CSS classes for login/logout conditional display (lines 38, 48, 77, 87)
  - ‚úÖ Uses WordPress native wp_logout_url() (line 85)
  - ‚úÖ Uses get_post_type_archive_link() for stories archive (line 53)

  ---
  Step 5.2: Ensure Filter Exists for Conditional Menu Items

  File: includes/class-fanfic-templates.php

  Verify that filter_menu_items_by_login_status() method exists (around line 42). If not, add it:

  /**
   * Filter menu items based on user login status
   *
   * Hides items with 'menu-item-logged-in' class if user is logged out
   * Hides items with 'menu-item-logged-out' class if user is logged in
   *
   * @since 1.0.0
   * @param array $items Menu items.
   * @param mixed $menu Menu object.
   * @return array Filtered menu items.
   */
  public static function filter_menu_items_by_login_status( $items, $menu ) {
      $is_logged_in = is_user_logged_in();

      foreach ( $items as $key => $item ) {
          // Hide logged-in items if user is logged out
          if ( ! $is_logged_in && in_array( 'menu-item-logged-in', $item->classes, true ) ) {
              unset( $items[ $key ] );
          }

          // Hide logged-out items if user is logged in
          if ( $is_logged_in && in_array( 'menu-item-logged-out', $item->classes, true ) ) {
              unset( $items[ $key ] );
          }
      }

      return $items;
  }

  ---
  Testing Instructions for Task 5

  1. Run Wizard:
    - Complete wizard to Step 5
    - Check: Menu "Fanfiction Automatic Menu" is created
  2. Test Menu (Logged Out):
    - Go to: Appearance ‚Üí Menus
    - View: "Fanfiction Automatic Menu"
    - Expected Items:
        - Home
      - Stories Archive
      - Members
      - Login
    - Not Visible:
        - Dashboard
      - Add Story
      - Logout
  3. Test Menu (Logged In):
    - Log in as author
    - Refresh page
    - Expected Items:
        - Home
      - Dashboard
      - Add Story
      - Stories Archive
      - Members
      - Logout
    - Not Visible:
        - Login
  4. Test Custom Slugs:
    - Change dashboard slug to "dashboard-test"
    - Run wizard again (or call create_fanfiction_menu() manually)
    - Expected: Dashboard menu item URL is /base_slug/dashboard-test/
  5. Verify URLs:
    - Click each menu item
    - Expected: All links work correctly with custom slugs

  ---
  üìù SUMMARY OF ALL CHANGES

  Files Modified (11 total):

  1. includes/class-fanfic-url-manager.php - Remove secondary paths, remove transient flush
  2. includes/class-fanfic-url-config.php - Update slug saving logic, fix form fields
  3. includes/class-fanfic-url-schema.php - Remove 'user' entry
  4. templates/template-search.php - Add header/footer, wrap shortcodes
  5. templates/template-members.php - Complete rewrite with WP_User_Query
  6. includes/functions.php - Update edit URL helper functions
  7. includes/class-fanfic-wizard.php - Remove edit pages from validation
  8. includes/class-fanfic-templates.php - Remove edit pages from creation, fix menu
  9. includes/class-fanfic-core.php - Comment out Dynamic Pages loading
  10. includes/class-fanfic-dynamic-pages.php - Add deprecation notice

  Options Deprecated:

  - fanfic_secondary_paths - No longer used

  Classes Deprecated:

  - Fanfic_Dynamic_Pages - Functionality moved to Fanfic_URL_Manager

  New Functionality:

  - ‚úÖ Single source of truth for dynamic page slugs
  - ‚úÖ Immediate cache flush on slug updates
  - ‚úÖ WordPress native author directory (WP_User_Query)
  - ‚úÖ Query parameter-based edit pages
  - ‚úÖ Menu with dynamic URLs respecting custom slugs

  ---
  üß™ FINAL TESTING CHECKLIST

  After ALL tasks complete:

  - Change dashboard slug from "dashboard" to "test-dash", save, visit /base_slug/test-dash/ - should work
  - Visit /base_slug/members/ - should show author list with pagination
  - Visit /base_slug/members/username/ - should show user profile
  - Visit /base_slug/members/username/?action=edit - should show edit form (if logged in as that user)
  - Visit /base_slug/search/ - should have full page header/footer
  - Create story, click edit - URL should be /base_slug/stories_slug/story-slug/?action=edit
  - Check: No WordPress pages named "Edit Story", "Edit Chapter", etc.
  - Run wizard, check menu has correct items with correct URLs
  - Test menu while logged in - should show Dashboard, Add Story, Logout
  - Test menu while logged out - should show Login only (not Dashboard/Add Story/Logout)
  - Check database: fanfic_secondary_paths option should not exist or be empty

  ---
  END OF IMPLEMENTATION PLAN
